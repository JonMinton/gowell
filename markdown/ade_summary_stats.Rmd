---
title: "diversity means and sds"
author: "Jon Minton"
date: "Tuesday, March 10, 2015"
output: html_document
---

# Request from Ade

Jon,
 
Meantime, do you think you could also produce a table showing the average (mean) values and s.d.s for the diversity scores on each dimension, for  all datazones in Greater Glasgow  and then also separately by SIMD 2012 quintile?
 
Yours,
Ade

#Mean and SDs for diversity scores

```{r prereqs, echo=FALSE, cache=TRUE, results='hide', message=FALSE, warning=FALSE}

# What are the sources of data?
rm(list=ls())

setwd("E:/repos/gowell")


require(repmis)
require(plyr)
require(tidyr)
require(stringr)
require(dplyr)

require(xtable)
require(ggplot2)
require(rgl)

require(vegan)

demo_div <- read.csv("data/derived/demographic_diversity_2010.csv") %>%
    tbl_df %>%
    rename(demographic=diversity)


dtype_div <- read.csv("data/derived/diversity_dwelling_type_2011.csv") %>%
    tbl_df %>%
    rename(dtype=diversity)

eth_div <- read.csv("data/derived/diversity_ethnicity_2011.csv") %>%
    tbl_df %>%
    rename(ethnicity=diversity)

sec_div <- read.csv("data/derived/diversity_sec_by_dz_2011_census.csv") %>%
    tbl_df %>%
    rename(sec=sec_div)

ten_div <- read.csv("data/derived/diversity_tenure_2001.csv" ) %>%
    tbl_df %>%
    rename(tenure=diversity)

spac_div <- read.csv("data/derived/diversity_space_2001.csv") %>%
    tbl_df %>%
    rename(space=diversity)

band_div <- read.csv("data/derived/diversity_dwelling_band_2011.csv") %>%
    tbl_df %>%
    rename(band=diversity)

joined <- Reduce(inner_join, list(demo_div, dtype_div, eth_div, sec_div, ten_div, spac_div, band_div))
```

##Mean and SD of raw results

Here are the mean and SDs of the diversity scores themselves. Such numbers are 
probably not too meaningful to compare as the scales are different. 

```{r table_raw, echo=FALSE, results="asis"}

tmp <- matrix(NA, nrow=7, ncol=2, 
        dimnames=list(
            c("demographic", "dwelling", "ethnic", "socioeconomic", "tenure", "space", "council tax band"),
            c("mean", "sd")
        )
    )

tmp["demographic", "mean"] <- mean(joined$demographic)
tmp["demographic", "sd"] <- sd(joined$demographic)

tmp["dwelling", "mean"] <- mean(joined$dtype)
tmp["dwelling", "sd"] <- sd(joined$dtype)

tmp["ethnic", "mean"] <- mean(joined$ethnicity)
tmp["ethnic", "sd"] <- sd(joined$ethnicity)

tmp["socioeconomic", "mean"] <- mean(joined$sec)
tmp["socioeconomic", "sd"] <- sd(joined$sec)

tmp["tenure", "mean"] <- mean(joined$tenure)
tmp["tenure", "sd"] <- sd(joined$tenure)

tmp["space", "mean"] <- mean(joined$space)
tmp["space", "sd"] <- sd(joined$space)

tmp["council tax band", "mean"] <- mean(joined$band)
tmp["council tax band", "sd"] <- sd(joined$band)

tbl <- xtable(tmp)
print(tbl, type="html")

```


##Results by SIMD quintile

Here are the mean and SDs of the diversity scores themselves. Such numbers are 
probably not too meaningful to compare as the scales are different. 

```{r table_raw, echo=FALSE, results="asis"}


simd_raw <- read.csv("data/simd/00410767.csv", header=T) %>%
    tbl_df

simd <- simd_raw %>%
    select(datazone=Data.Zone, la=Local.Authority.Name, simd=Overall.SIMD.2012.Score)


greater_glasgow_dzs <- read.csv("data/geographies/dzs_in_greater_glasgow.csv")  %>% tbl_df %>%
    rename(datazone=dz_2001)

simd <- simd %>%
    right_join(greater_glasgow_dzs) %>%
    select(-chp)

simd <- simd  %>% mutate(simd_q=ntile(simd, 5))

joined <- joined  %>%  inner_join(simd)

summaries_quints <- joined  %>% 
    select(datazone, demographic, dtype, ethnicity, 
           sec, tenure, space, band, simd_q)  %>% 
    gather(key=type, value=value, -datazone, -simd_q) %>%
    group_by(type, simd_q) %>%
    summarise(mean=mean(value), sd=sd(value)) 

summaries_quints %>%
    ggplot +
    geom_line(aes(x=simd_q, y=mean)) +
    geom_segment(aes(x=simd_q, xend=simd_q, y=mean-2*sd, yend=mean+2*sd)) +
    facet_wrap(~ type)

summaries_quints <- joined  %>% 
    select(datazone, demographic, dtype, ethnicity, 
           sec, tenure, space, band, simd_q)  %>% 
    mutate_each(vars=c(-datazone, -simd_q), funs(percent_rank)) %>%
    gather(key=type, value=value, -datazone, -simd_q) %>%
    group_by(type, simd_q) %>%
    summarise(mean=mean(value), sd=sd(value), n=n()) 

summaries_quints %>%
    ggplot +
    geom_line(aes(x=simd_q, y=mean)) +
    geom_segment(aes(x=simd_q, xend=simd_q, y=mean-2*sd/sqrt(n), yend=mean+2*sd/sqrt(n))) +
    facet_wrap(~ type)

```

